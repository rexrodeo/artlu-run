{% extends "base.html" %}
{% block title %}Get Your {{ race.name }} Plan — ARTLU.RUN{% endblock %}

{% block content %}
<section class="page-header page-header-compact">
    <div class="container">
        <h1>Get Your {{ race.name }} Plan</h1>
        <p>{{ race.distance }} · {{ race.elevation_gain }} gain · {{ race.location }}</p>
    </div>
</section>

<section class="section section-light">
    <div class="container container-narrow">
        <div class="purchase-layout">
            <!-- Form -->
            <div class="purchase-form-wrap">
                <h2>Your Details</h2>
                <p class="text-muted mb-2">We'll use this to build your personalized race plan.</p>

                <form action="/create-checkout-session" method="POST" id="purchase-form" class="purchase-form">
                    <input type="hidden" name="race_slug" value="{{ race.slug }}">
                    <input type="hidden" name="race_name" value="{{ race.name }}">

                    <div class="form-group">
                        <label for="name">Your Name</label>
                        <input type="text" id="name" name="name" required placeholder="Alex Runner" class="form-input">
                    </div>

                    <div class="form-group">
                        <label for="email">Email Address</label>
                        <input type="email" id="email" name="email" required placeholder="you@email.com" class="form-input">
                        <span class="form-hint">We'll send your access code here</span>
                    </div>

                    <div class="form-group">
                        <label for="goal_time">Race Goal Time</label>
                        <input type="text" id="goal_time" name="goal_time" required placeholder="e.g. 24 hours, sub-30, finish" class="form-input">
                        <span class="form-hint">Your target finish time or goal</span>
                    </div>

                    <div class="form-row-2col">
                        <div class="form-group">
                            <label for="city">Training City</label>
                            <input type="text" id="city" name="city" required placeholder="Start typing..." class="form-input" list="city-list" autocomplete="off">
                            <datalist id="city-list"></datalist>
                        </div>
                        <div class="form-group">
                            <label for="state">State</label>
                            <select id="state" name="state" required class="form-input">
                                <option value="">Select...</option>
                                <option value="AL">Alabama</option>
                                <option value="AK">Alaska</option>
                                <option value="AZ">Arizona</option>
                                <option value="AR">Arkansas</option>
                                <option value="CA">California</option>
                                <option value="CO">Colorado</option>
                                <option value="CT">Connecticut</option>
                                <option value="DE">Delaware</option>
                                <option value="FL">Florida</option>
                                <option value="GA">Georgia</option>
                                <option value="HI">Hawaii</option>
                                <option value="ID">Idaho</option>
                                <option value="IL">Illinois</option>
                                <option value="IN">Indiana</option>
                                <option value="IA">Iowa</option>
                                <option value="KS">Kansas</option>
                                <option value="KY">Kentucky</option>
                                <option value="LA">Louisiana</option>
                                <option value="ME">Maine</option>
                                <option value="MD">Maryland</option>
                                <option value="MA">Massachusetts</option>
                                <option value="MI">Michigan</option>
                                <option value="MN">Minnesota</option>
                                <option value="MS">Mississippi</option>
                                <option value="MO">Missouri</option>
                                <option value="MT">Montana</option>
                                <option value="NE">Nebraska</option>
                                <option value="NV">Nevada</option>
                                <option value="NH">New Hampshire</option>
                                <option value="NJ">New Jersey</option>
                                <option value="NM">New Mexico</option>
                                <option value="NY">New York</option>
                                <option value="NC">North Carolina</option>
                                <option value="ND">North Dakota</option>
                                <option value="OH">Ohio</option>
                                <option value="OK">Oklahoma</option>
                                <option value="OR">Oregon</option>
                                <option value="PA">Pennsylvania</option>
                                <option value="RI">Rhode Island</option>
                                <option value="SC">South Carolina</option>
                                <option value="SD">South Dakota</option>
                                <option value="TN">Tennessee</option>
                                <option value="TX">Texas</option>
                                <option value="UT">Utah</option>
                                <option value="VT">Vermont</option>
                                <option value="VA">Virginia</option>
                                <option value="WA">Washington</option>
                                <option value="WV">West Virginia</option>
                                <option value="WI">Wisconsin</option>
                                <option value="WY">Wyoming</option>
                                <option value="DC">Washington D.C.</option>
                                <option value="INT">International</option>
                            </select>
                        </div>
                    </div>
                    <span class="form-hint">We'll find Strava training segments near this location</span>

                    <button type="submit" class="btn btn-primary btn-lg btn-block mt-2" id="purchase-btn">
                        Get My Plan — {{ plan_price }}
                    </button>
                    <p class="text-center text-muted text-sm mt-1">Secure payment via Stripe. Plan delivered in 24–48 hours.</p>
                </form>
            </div>

            <!-- What's Included sidebar -->
            <div class="purchase-sidebar">
                <div class="sidebar-card">
                    <h3>What's in Your Plan</h3>
                    <ul class="check-list">
                        <li>Mile-by-mile pacing strategy for your goal time</li>
                        <li>Strava training segments near {{ race.location if race.country != 'USA' else 'your city' }}</li>
                        <li>Course section breakdown with strategies</li>
                        <li>Race-day nutrition & hydration plan</li>
                        <li>Gear checklist for {{ race.name }}</li>
                        <li>Weather preparation guide</li>
                        <li>Common mistakes & how to avoid them</li>
                        <li>Mental game tactics for the hardest sections</li>
                    </ul>
                </div>
                <div class="sidebar-card sidebar-card-muted">
                    <h3>How It Works</h3>
                    <ol class="step-list">
                        <li>Fill out the form with your details</li>
                        <li>Complete payment ({{ plan_price }})</li>
                        <li>Receive your access code via email</li>
                        <li>Your plan is built within 24–48 hours</li>
                        <li>Access your plan anytime at /dashboard</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
// City autocomplete based on state selection
const cities = {
    'CO': ['Denver', 'Boulder', 'Colorado Springs', 'Fort Collins', 'Golden', 'Littleton', 'Arvada', 'Lakewood', 'Aurora', 'Pueblo'],
    'CA': ['Los Angeles', 'San Francisco', 'San Diego', 'Sacramento', 'Oakland', 'San Jose', 'Fresno', 'Long Beach', 'Santa Barbara', 'Berkeley'],
    'TX': ['Austin', 'Houston', 'Dallas', 'San Antonio', 'Fort Worth', 'El Paso', 'Arlington', 'Plano', 'Lubbock', 'Amarillo'],
    'UT': ['Salt Lake City', 'Provo', 'Ogden', 'St. George', 'Logan', 'Park City', 'Moab', 'Lehi', 'Orem', 'Sandy'],
    'AZ': ['Phoenix', 'Scottsdale', 'Tucson', 'Flagstaff', 'Tempe', 'Mesa', 'Chandler', 'Sedona', 'Fountain Hills', 'Gilbert'],
    'NY': ['New York', 'Brooklyn', 'Buffalo', 'Rochester', 'Syracuse', 'Albany', 'Ithaca', 'White Plains', 'Yonkers', 'New Rochelle'],
    'WA': ['Seattle', 'Tacoma', 'Spokane', 'Bellevue', 'Vancouver', 'Olympia', 'Bellingham', 'Kennewick', 'Redmond', 'Kirkland'],
    'OR': ['Portland', 'Eugene', 'Salem', 'Bend', 'Medford', 'Corvallis', 'Ashland', 'Hood River', 'Beaverton', 'Hillsboro'],
    'NC': ['Charlotte', 'Raleigh', 'Asheville', 'Durham', 'Greensboro', 'Wilmington', 'Chapel Hill', 'Winston-Salem', 'Boone', 'Fayetteville'],
    'GA': ['Atlanta', 'Savannah', 'Augusta', 'Athens', 'Marietta', 'Roswell', 'Alpharetta', 'Decatur', 'Macon', 'Columbus'],
};

const stateSelect = document.getElementById('state');
const cityInput = document.getElementById('city');
const cityList = document.getElementById('city-list');

if (stateSelect && cityList) {
    stateSelect.addEventListener('change', function() {
        cityList.innerHTML = '';
        const stateCities = cities[this.value] || [];
        stateCities.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            cityList.appendChild(opt);
        });
    });
}

// Form submit loading state
const form = document.getElementById('purchase-form');
const btn = document.getElementById('purchase-btn');
if (form && btn) {
    form.addEventListener('submit', function() {
        if (form.checkValidity()) {
            btn.textContent = 'Redirecting to payment...';
            btn.disabled = true;
        }
    });
}
</script>
{% endblock %}
